var le=Object.defineProperty,fe=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable;var J=(e,t,n)=>t in e?le(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,F=(e,t)=>{for(var n in t||(t={}))ue.call(t,n)&&J(e,n,t[n]);if(W)for(var n of W(t))he.call(t,n)&&J(e,n,t[n]);return e},Q=(e,t)=>fe(e,de(t));const N=({width:e,height:t},{top:n,left:s,bottom:i,right:o})=>new DOMRect(s,n,e-s-o,t-n-i),G=(e,t)=>{let n=2;for(;;){const s=n*2+n%2;if(t/s<e)break;n=s}return[n,t/n]},_=(e,t,n)=>(n<0&&(n+=1),n>1&&(n-=1),n<.16666666666666666?e+(t-e)*6*n:n<.5?t:n<.6666666666666666?e+(t-e)*(.6666666666666666-n)*6:e),me=(e,t,n)=>{let s,i,o;if(t===0)s=i=o=n;else{const r=n<.5?n*(1+t):n+t-n*t,c=2*n-r;s=_(c,r,e+.3333333333333333),i=_(c,r,e),o=_(c,r,e-.3333333333333333)}return[Math.round(s*255),Math.round(i*255),Math.round(o*255)]};const ie=new Array(256);for(let e=0;e<=255;e++){const t=ie[255-e]=new Uint8ClampedArray(4),n=e/255*300,s=n>270?.5*((300-n)/(300-270)):.5;t.set(me(n/360,1,s),0),t[3]=255}const T=ie,V=new Uint8ClampedArray([0,0,0,255]),ge={minDecibels:-120,maxDecibels:-20},ye=({context:e,margin:t,layout:n,decibelRange:s=ge})=>{const i=N(e.canvas,t),o=i.right+10,r=i.top-1,c=o+n.width,h=i.bottom+1,l=e.createLinearGradient(o,r,c,h);for(let y=0;y<T.length;y++){const[g,u,M]=T[T.length-y-1];l.addColorStop(y/T.length,`rgb(${g}, ${u}, ${M})`)}e.fillStyle=l,e.fillRect(o,r,n.width,i.height),e.textAlign="left",e.textBaseline="middle";const[m,d]=G(n.tickMinDistance,i.height),I=s.minDecibels-s.maxDecibels;for(let y=0;y<=m;y++){const g=r+y*d,u=`${Math.floor(y/m*I+s.maxDecibels)} dB`;e.fillStyle=l,e.fillRect(c,g,n.tickLength,n.tickThickness),e.fillStyle="white",e.fillText(u,c+n.tickLength+2,g+1)}},be=({context:e,margin:t,layout:n,sampleRate:s=48e3})=>{const i=N(e.canvas,t),o=i.height+1,[r,c]=G(n.tickMinDistance,o),h=s/2/1e3;e.textAlign="right",e.textBaseline="middle";for(let l=0;l<=r;l++){const m=i.top+l*c-1,d=`${Math.floor((r-l)/r*h)} kHz`;e.fillRect(i.left-n.tickLength,m,n.tickLength,n.tickThickness),e.fillText(d,i.left-n.tickLength-2,m+1)}},we=({context:e,margin:t,text:n})=>{e.textAlign="left",e.textBaseline="bottom",e.font="14px monospace",e.fillText(n,t.left,t.top-8)},Be=e=>`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`,pe=({context:e,time:t,layout:n,margin:s})=>{const i=N(e.canvas,s),o=i.width+1,[r,c]=G(n.tickMinDistance*2,o),h=t.end-t.start;e.fillStyle="white",e.strokeStyle="white",e.textAlign="center",e.textBaseline="hanging",e.font="12px monospace";for(let l=0;l<=r;l++){const m=i.left+l*c-1,d=Be(Math.floor(t.start+l/r*h));e.fillRect(m,i.bottom,n.tickThickness,n.tickLength),e.fillText(d,m,i.bottom+n.tickLength+2)}};function Se(e){return(t,n,s,i={})=>{t=Array.isArray(t)?t:[t],n=Array.isArray(n)?n:[n];const o=t.map(r=>typeof r=="string"?document.querySelector(r):r);for(const r of o)for(const c of n)r[e](c,s,F({capture:!1},i));return[o,n,s,i]}}const se=Se("addEventListener"),De=(e,t=devicePixelRatio)=>{e.width=0,e.height=0;const n=e.getBoundingClientRect(),s=Math.round(t*n.right)-Math.round(t*n.left),i=Math.round(t*n.bottom)-Math.round(t*n.top);return{width:s,height:i}},ke=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],Ae=["B","kiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],Me=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Re=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],ee=(e,t,n)=>{let s=e;return typeof t=="string"||Array.isArray(t)?s=e.toLocaleString(t,n):(t===!0||n!==void 0)&&(s=e.toLocaleString(void 0,n)),s};function Te(e,t){if(!Number.isFinite(e))throw new TypeError(`Expected a finite number, got ${typeof e}: ${e}`);t=F({bits:!1,binary:!1},t);const n=t.bits?t.binary?Re:Me:t.binary?Ae:ke;if(t.signed&&e===0)return` 0 ${n[0]}`;const s=e<0,i=s?"-":t.signed?"+":"";s&&(e=-e);let o;if(t.minimumFractionDigits!==void 0&&(o={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(o=F({maximumFractionDigits:t.maximumFractionDigits},o)),e<1){const l=ee(e,t.locale,o);return i+l+" "+n[0]}const r=Math.min(Math.floor(t.binary?Math.log(e)/Math.log(1024):Math.log10(e)/3),n.length-1);e/=(t.binary?1024:1e3)**r,o||(e=e.toPrecision(3));const c=ee(Number(e),t.locale,o),h=n[r];return i+c+" "+h}const xe=async(e,t)=>new AudioContext(t).decodeAudioData(await e.arrayBuffer()),oe=e=>{const t=document.createElement("canvas"),n=t.getContext("2d",e);return[t,n]},re=(e,t)=>{const n=new MutationObserver(t);return n.observe(e,{attributes:!0,attributeFilter:["width","height"]}),()=>n.disconnect()},Ie=e=>{let t=-1;const n=()=>{e(),t=requestAnimationFrame(n)};return t=requestAnimationFrame(n),()=>cancelAnimationFrame(t)},Ee="AudioFileSpectrumRenderer",Fe=e=>{const[t,n]=oe();let s=!1,i,o,r,c;const h={smoothingTimeConstant:0,minDecibels:-120,maxDecibels:-20},l=g=>{let u=2;for(;u/2<g;)u*=2;return u},m=()=>{c&&i&&o&&r&&e({canvas:t,audioFile:c,audioContext:i,audioAnalyzer:o,audioBuffer:r})},d=async(g=c)=>{if(s||!g)return;s=!0,c=g,r=await xe(g);const{width:u,height:M}=t,C=new Array(u);i=new OfflineAudioContext(r),o=i.createAnalyser(),o.fftSize=l(M),o.smoothingTimeConstant=0,o.connect(i.destination),Object.assign(o,h);const R=r.duration/C.length,D=o.frequencyBinCount;for(let a=0;a<C.length;a++){const S=a*R;i.suspend(S).then(()=>{i==null||i.resume(),o==null||o.getByteFrequencyData(C[a]=new Uint8Array(D))})}const w=i.createBufferSource();w.buffer=r,w.connect(o),w.start(),await i.startRendering();const B=new ImageData(u,M);for(let a=0;a<u;a++){const S=C[a];for(let b=0;b<M;b++){const p=S[b];if(p){const v=(a+(M-b-1)*u)*4,E=T[p];B.data.set(E,v)}}}n.putImageData(B,0,0),s=!1,m()},I=re(t,()=>{s=!1,d()});return{name:Ee,analyzerOptions:h,resize:(g,u)=>{t.width=g,t.height=u},render:d,destroy:I}},Le="RealtimeSpectrumRenderer",ze=e=>{const[t,n]=oe();let s=!1,i,o,r;const c={smoothingTimeConstant:0,fftSize:2**12,minDecibels:-120,maxDecibels:-20};let h=-1,l=0;const m={start:0,end:0},d=[],I=()=>{i&&o&&e({canvas:t,time:m,audioContext:i,audioAnalyzer:o,bufferSize:l})},y=re(t,()=>{const{width:R,height:D}=t;if(!s||!d.length)return;const w=d.slice(-R),B=new ImageData(w.length,D);for(let a=0;a<B.data.length;a+=4){const S=D-Math.floor(a/4/B.width),b=a/4%B.width,p=w[b],v=p.buffer.length/B.height,E=p.buffer[Math.floor(S*v)];if(E){const U=T[E];B.data.set(U,a)}else B.data.set(V,a)}h=Math.min(w.length-1),n.putImageData(B,0,0),I()}),g=async()=>{y(),await u()},u=async()=>{r==null||r(),await(i==null?void 0:i.close())};return{name:Le,analyzerOptions:c,resize:(R,D)=>{t.width=R,t.height=D},start:async()=>{if(s)return;const R=performance.now();s=!0;const D=await navigator.mediaDevices.getUserMedia({audio:{deviceId:"default"}});i=new AudioContext;const w=o=i.createAnalyser();i.createMediaStreamSource(D).connect(o),r=Ie(()=>{var Y,Z;const{height:a,width:S}=t,b=new Uint8Array(w.frequencyBinCount),p=new ImageData(1,a),v=b.length/a,E=Math.ceil(performance.now()-R);Object.assign(w,c),w.getByteFrequencyData(b);for(let O=0;O<a;O++){const X=b[Math.floor(O*v)],j=(a-O-1)*4;if(X){const ae=T[X];p.data.set(ae,j)}else p.data.set(V,j)}const U=d.length?((Z=(Y=d.at(-1))==null?void 0:Y.at)!=null?Z:0)/1e3/d.length:0;h===S-1?(n.globalCompositeOperation="copy",n.drawImage(t,-1,0),n.putImageData(p,h,0),n.globalCompositeOperation="source-over",m.end=U*d.length,m.start=U*(d.length-S)):(n.putImageData(p,h++,0),m.end=U*S),d.push({buffer:b,at:E}),l+=b.length,I()})},stop:u,destroy:g}},A={top:35,right:100,bottom:35,left:65},H={tickMinDistance:50,tickThickness:1,tickLength:10},Ce=Q(F({},H),{width:10}),ve=F({},H),x=document.getElementById("canvas"),k=x.getContext("2d",{alpha:!1});let L,P,$,f;const q=(e,t)=>{const n=N(x,A);k.clearRect(0,0,x.width,x.height),t&&k.drawImage(t,A.left,A.top),k.strokeStyle="white",k.strokeRect(n.left-.5,n.top-.5,n.width+1,n.height+1),$&&pe({context:k,margin:A,time:$,layout:H}),ye({context:k,margin:A,decibelRange:P,layout:Ce}),be({context:k,margin:A,layout:ve,sampleRate:L==null?void 0:L.sampleRate}),we({context:k,margin:A,text:e})},z=()=>{const{width:e,height:t}=De(x),{top:n,right:s,bottom:i,left:o}=A;x.width=e,x.height=t,f==null||f.resize(e-o-s,t-n-i),q(L?"Loading...":'Record (press "R") or select a file to render the spectrum for :)')},Ue=()=>{f==null||f.destroy(),f=Fe(e=>{const t=e.audioContext.sampleRate.toLocaleString(),n=e.audioBuffer.length/e.audioBuffer.duration*8,s=`${e.audioFile.name} (${e.audioFile.type}, ${t} Hz, ${n/1e3}kbps, ${e.audioBuffer.numberOfChannels} channels)`;$={start:0,end:e.audioBuffer.duration},P=e.audioAnalyzer,L=e.audioContext,q(s,e.canvas)}),z()},ce=()=>{f==null||f.destroy(),f=ze(e=>{const t=e.audioContext.sampleRate.toLocaleString(),n=Te(e.bufferSize,{minimumFractionDigits:2,maximumFractionDigits:2}),s=`\u{1F534} Recording with a sample-rate of ${t} (Buffer: ${n})`;$=e.time,P=e.audioAnalyzer,L=e.audioContext,q(s,e.canvas)}),z()},K=()=>{var e;return(e=document.getElementById("help"))==null?void 0:e.classList.toggle("visible")};se("#file-input","change",e=>{var t;(f==null?void 0:f.name)!=="AudioFileSpectrumRenderer"&&Ue(),f.render((t=e.target.files)==null?void 0:t[0])});se(window,"keydown",e=>{var t;if(e.ctrlKey||e.metaKey){if(e.preventDefault(),!f)return;switch(e.code){case"ArrowUp":f.analyzerOptions[e.shiftKey?"minDecibels":"maxDecibels"]+=1;break;case"ArrowDown":f.analyzerOptions[e.shiftKey?"minDecibels":"maxDecibels"]-=1;break}}else switch(e.code){case"KeyF":(t=document.getElementById("header"))==null||t.classList.toggle("visible"),z();break;case"KeyH":K();break;case"KeyR":ce(),f.start()}});window.addEventListener("resize",z);document.addEventListener("fullscreenchange",z);var te;(te=document.getElementById("help-screen-btn"))==null||te.addEventListener("click",K);var ne;(ne=document.getElementById("help"))==null||ne.addEventListener("click",K);z();ce();
