var re=Object.defineProperty,ae=Object.defineProperties;var le=Object.getOwnPropertyDescriptors;var W=Object.getOwnPropertySymbols;var fe=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var J=(e,n,t)=>n in e?re(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,U=(e,n)=>{for(var t in n||(n={}))fe.call(n,t)&&J(e,t,n[t]);if(W)for(var t of W(n))de.call(n,t)&&J(e,t,n[t]);return e},Q=(e,n)=>ae(e,le(n));const _=(e,n,t)=>(t<0&&(t+=1),t>1&&(t-=1),t<.16666666666666666?e+(n-e)*6*t:t<.5?n:t<.6666666666666666?e+(n-e)*(.6666666666666666-t)*6:e),ue=(e,n,t)=>{let s,i,o;if(n===0)s=i=o=t;else{const c=t<.5?t*(1+n):t+n-t*n,r=2*t-c;s=_(r,c,e+.3333333333333333),i=_(r,c,e),o=_(r,c,e-.3333333333333333)}return[Math.round(s*255),Math.round(i*255),Math.round(o*255)]};const ie=new Array(256);for(let e=0;e<=255;e++){const n=ie[255-e]=new Uint8ClampedArray(4),t=e/255*300,s=t>270?.5*((300-t)/(300-270)):.5;n.set(ue(t/360,1,s),0),n[3]=255}const v=ie,V=new Uint8ClampedArray([0,0,0,255]),he=async(e,n)=>new AudioContext(n).decodeAudioData(await e.arrayBuffer()),se=e=>{const n=document.createElement("canvas"),t=n.getContext("2d",e);return[n,t]},oe=(e,n)=>{const t=new MutationObserver(n);return t.observe(e,{attributes:!0,attributeFilter:["width","height"]}),()=>t.disconnect()},me=e=>{let n=-1;const t=()=>{e(),n=requestAnimationFrame(t)};return n=requestAnimationFrame(t),()=>cancelAnimationFrame(n)},ge="RealtimeSpectrumRenderer",ye=e=>{const[n,t]=se();let s=!1,i,o,c;const r={smoothingTimeConstant:0,fftSize:2**12,minDecibels:-120,maxDecibels:-20};let h=-1,l=0;const m={start:0,end:0},d=[],x=()=>{i&&o&&e({canvas:n,time:m,audioContext:i,audioAnalyzer:o,bufferSize:l})},y=oe(n,()=>{const{width:T,height:k}=n;if(!s||!d.length)return;const w=d.slice(-T),p=new ImageData(w.length,k);for(let a=0;a<p.data.length;a+=4){const S=k-Math.floor(a/4/p.width),b=a/4%p.width,B=w[b],L=B.buffer.length/p.height,E=B.buffer[Math.floor(S*L)];if(E){const z=v[E];p.data.set(z,a)}else p.data.set(V,a)}h=Math.min(w.length-1),t.putImageData(p,0,0),x()}),g=async()=>{y(),await u()},u=async()=>{c==null||c(),await(i==null?void 0:i.close())};return{name:ge,analyzerOptions:r,resize:(T,k)=>{n.width=T,n.height=k},start:async()=>{if(s)return;const T=performance.now();s=!0;const k=await navigator.mediaDevices.getUserMedia({audio:{deviceId:"default"}});i=new AudioContext;const w=o=i.createAnalyser();i.createMediaStreamSource(k).connect(o),c=me(()=>{var Y,Z;const{height:a,width:S}=n,b=new Uint8Array(w.frequencyBinCount),B=new ImageData(1,a),L=b.length/a,E=Math.ceil(performance.now()-T);Object.assign(w,r),w.getByteFrequencyData(b);for(let O=0;O<a;O++){const X=b[Math.floor(O*L)],j=(a-O-1)*4;if(X){const ce=v[X];B.data.set(ce,j)}else B.data.set(V,j)}const z=d.length?((Z=(Y=d.at(-1))==null?void 0:Y.at)!=null?Z:0)/1e3/d.length:0;h===S-1?(t.globalCompositeOperation="copy",t.drawImage(n,-1,0),t.putImageData(B,h,0),t.globalCompositeOperation="source-over",m.end=z*d.length,m.start=z*(d.length-S)):(t.putImageData(B,++h,0),m.end=z*S),d.push({buffer:b,at:E}),l+=b.length,x()})},stop:u,destroy:g}},be="AudioFileSpectrumRenderer",we=e=>{const[n,t]=se();let s=!1,i,o,c,r;const h={smoothingTimeConstant:0,minDecibels:-120,maxDecibels:-20},l=g=>{let u=2;for(;u/2<g;)u*=2;return u},m=()=>{r&&i&&o&&c&&e({canvas:n,audioFile:r,audioContext:i,audioAnalyzer:o,audioBuffer:c})},d=async(g=r)=>{if(s||!g)return;s=!0,r=g,c=await he(g);const{width:u,height:R}=n,C=new Array(u);i=new OfflineAudioContext(c),o=i.createAnalyser(),o.fftSize=l(R),o.smoothingTimeConstant=0,o.connect(i.destination),Object.assign(o,h);const T=c.duration/C.length,k=o.frequencyBinCount;for(let a=0;a<C.length;a++){const S=a*T;i.suspend(S).then(()=>{i==null||i.resume(),o==null||o.getByteFrequencyData(C[a]=new Uint8Array(k))})}const w=i.createBufferSource();w.buffer=c,w.connect(o),w.start(),await i.startRendering();const p=new ImageData(u,R);for(let a=0;a<u;a++){const S=C[a];for(let b=0;b<R;b++){const B=S[b];if(B){const L=(a+(R-b-1)*u)*4,E=v[B];p.data.set(E,L)}}}t.putImageData(p,0,0),s=!1,m()},x=oe(n,()=>{s=!1,d()});return{name:be,analyzerOptions:h,resize:(g,u)=>{n.width=g,n.height=u},render:d,destroy:x}},N=({width:e,height:n},{top:t,left:s,bottom:i,right:o})=>new DOMRect(s,t,e-s-o,n-t-i),G=(e,n)=>{let t=2;for(;;){const s=t*2+t%2;if(n/s<e)break;t=s}return[t,n/t]},pe={minDecibels:-120,maxDecibels:-20},Be=({context:e,margin:n,layout:t,decibelRange:s=pe})=>{const i=N(e.canvas,n),o=i.right+10,c=i.top-1,r=o+t.width,h=i.bottom+1,l=e.createLinearGradient(o,c,r,h);for(let y=0;y<v.length;y++){const[g,u,R]=v[v.length-y-1];l.addColorStop(y/v.length,`rgb(${g}, ${u}, ${R})`)}e.fillStyle=l,e.fillRect(o,c,t.width,i.height),e.textAlign="left",e.textBaseline="middle";const[m,d]=G(t.tickMinDistance,i.height),x=s.minDecibels-s.maxDecibels;for(let y=0;y<=m;y++){const g=c+y*d,u=`${Math.floor(y/m*x+s.maxDecibels)} dB`;e.fillStyle=l,e.fillRect(r,g,t.tickLength,t.tickThickness),e.fillStyle="white",e.fillText(u,r+t.tickLength+2,g+1)}},Se=({context:e,margin:n,layout:t,sampleRate:s=48e3})=>{const i=N(e.canvas,n),o=i.height+1,[c,r]=G(t.tickMinDistance,o),h=s/2/1e3;e.textAlign="right",e.textBaseline="middle";for(let l=0;l<=c;l++){const m=i.top+l*r-1,d=`${Math.floor((c-l)/c*h)} kHz`;e.fillRect(i.left-t.tickLength,m,t.tickLength,t.tickThickness),e.fillText(d,i.left-t.tickLength-2,m+1)}},ke=({context:e,margin:n,text:t})=>{e.textAlign="left",e.textBaseline="bottom",e.font="14px monospace",e.fillText(t,n.left,n.top-8)},De=e=>`${Math.floor(e/60)}:${String(e%60).padStart(2,"0")}`,Me=({context:e,time:n,layout:t,margin:s})=>{const i=N(e.canvas,s),o=i.width+1,[c,r]=G(t.tickMinDistance*2,o),h=n.end-n.start;e.fillStyle="white",e.strokeStyle="white",e.textAlign="center",e.textBaseline="hanging",e.font="12px monospace";for(let l=0;l<=c;l++){const m=i.left+l*r-1,d=De(Math.floor(n.start+l/c*h));e.fillRect(m,i.bottom,t.tickThickness,t.tickLength),e.fillText(d,m,i.bottom+t.tickLength+2)}},Ae=(e,n=devicePixelRatio)=>{e.width=0,e.height=0;const t=e.getBoundingClientRect(),s=Math.round(n*t.right)-Math.round(n*t.left),i=Math.round(n*t.bottom)-Math.round(n*t.top);return{width:s,height:i}},Re=({accept:e,multiple:n}={})=>{const t=document.createElement("input");return document.body.appendChild(t),t.type="file",t.style.display="none",e&&(t.accept=e),n&&(t.multiple=n),new Promise((s,i)=>{t.onchange=()=>{var c;const o=Array.from((c=t.files)!=null?c:[]);o.length?s(n?o:o[0]):i()},document.body.removeChild(t),t.click()})},Te=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],ve=["B","kiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],xe=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],Ee=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],ee=(e,n,t)=>{let s=e;return typeof n=="string"||Array.isArray(n)?s=e.toLocaleString(n,t):(n===!0||t!==void 0)&&(s=e.toLocaleString(void 0,t)),s};function Ie(e,n){if(!Number.isFinite(e))throw new TypeError(`Expected a finite number, got ${typeof e}: ${e}`);n=U({bits:!1,binary:!1},n);const t=n.bits?n.binary?Ee:xe:n.binary?ve:Te;if(n.signed&&e===0)return` 0 ${t[0]}`;const s=e<0,i=s?"-":n.signed?"+":"";s&&(e=-e);let o;if(n.minimumFractionDigits!==void 0&&(o={minimumFractionDigits:n.minimumFractionDigits}),n.maximumFractionDigits!==void 0&&(o=U({maximumFractionDigits:n.maximumFractionDigits},o)),e<1){const l=ee(e,n.locale,o);return i+l+" "+t[0]}const c=Math.min(Math.floor(n.binary?Math.log(e)/Math.log(1024):Math.log10(e)/3),t.length-1);e/=(n.binary?1024:1e3)**c,o||(e=e.toPrecision(3));const r=ee(Number(e),n.locale,o),h=t[c];return i+r+" "+h}const M={top:35,right:100,bottom:35,left:65},H={tickMinDistance:50,tickThickness:1,tickLength:10},Fe=Q(U({},H),{width:10}),Ce=U({},H),A=document.getElementById("canvas"),D=A.getContext("2d",{alpha:!1});let I,P,$,f;const K=(e,n)=>{const t=N(A,M);D.clearRect(0,0,A.width,A.height),n&&D.drawImage(n,M.left,M.top),D.strokeStyle="white",D.strokeRect(t.left-.5,t.top-.5,t.width+1,t.height+1),$&&Me({context:D,margin:M,time:$,layout:H}),Be({context:D,margin:M,decibelRange:P,layout:Fe}),Se({context:D,margin:M,layout:Ce,sampleRate:I==null?void 0:I.sampleRate}),ke({context:D,margin:M,text:e})},F=()=>{const{width:e,height:n}=Ae(A),{top:t,right:s,bottom:i,left:o}=M;A.width=e,A.height=n,f==null||f.resize(e-o-s,n-t-i),K(I?"Loading...":'Record (press "R") or select a file to render the spectrum for :)')},Le=()=>{f==null||f.destroy(),f=we(e=>{const n=e.audioContext.sampleRate.toLocaleString(),t=e.audioBuffer.length/e.audioBuffer.duration*8,s=`${e.audioFile.name} (${e.audioFile.type}, ${n} Hz, ${t/1e3}kbps, ${e.audioBuffer.numberOfChannels} channels)`;$={start:0,end:e.audioBuffer.duration},P=e.audioAnalyzer,I=e.audioContext,K(s,e.canvas)}),F()},ze=()=>{f==null||f.destroy(),f=ye(e=>{const n=e.audioContext.sampleRate.toLocaleString(),t=Ie(e.bufferSize,{minimumFractionDigits:2,maximumFractionDigits:2}),s=`\u{1F534} Recording with a sample-rate of ${n} (Buffer: ${t})`;$=e.time,P=e.audioAnalyzer,I=e.audioContext,K(s,e.canvas)}),F()},q=()=>{var e;return(e=document.getElementById("help"))==null?void 0:e.classList.toggle("visible")};A.addEventListener("click",()=>{Re({multiple:!1,accept:"audio/*"}).then(e=>{(f==null?void 0:f.name)!=="AudioFileSpectrumRenderer"&&Le(),f.render(e)})});window.addEventListener("keydown",e=>{var n;if(e.ctrlKey||e.metaKey){if(e.preventDefault(),!f)return;switch(e.code){case"ArrowUp":f.analyzerOptions[e.shiftKey?"minDecibels":"maxDecibels"]+=1;break;case"ArrowDown":f.analyzerOptions[e.shiftKey?"minDecibels":"maxDecibels"]-=1;break}}else switch(e.code){case"KeyF":(n=document.getElementById("header"))==null||n.classList.toggle("visible"),F();break;case"KeyH":q();break;case"KeyR":ze(),f.start()}});window.addEventListener("resize",F);document.addEventListener("fullscreenchange",F);var te;(te=document.getElementById("help-screen-btn"))==null||te.addEventListener("click",q);var ne;(ne=document.getElementById("help"))==null||ne.addEventListener("click",q);F();
